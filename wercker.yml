# # box: ruby:2.3.1
# # services:
# #   - postgres
# # build:
# #   steps:
# #     - bundle-install
# #     - rails-database-yml
# #     - desmondmorris/selenium-install@0.0.2

# #     - script:
# #         name: setup database
# #         code: bundle exec rake db:create db:migrate RAILS_ENV=test

# #     - script:
# #         name: rspec
# #         code: bundle exec rspec

# # deploy:
# #   steps:
# #     - heroku-deploy:
# #         key-name: DEPLOYMENT_KEY
# #         install-toolbelt: true
# #         retry: true
# #         run: rake db:migrate



# # box: wercker/ubuntu12.04-ruby2.0.0
# box: ruby:2.3.1
# services:
#   - postgres
# build:
#   steps:
#       - script:
#           name: Make tmp directory
#           code: mkdir tmp

#       - script:
#           name: Enable virtual display
#           code: |-
#             # Start xvfb which gives the context an virtual display
#             # which is required for tests that require an GUI
#             export DISPLAY=:99.0
#             start-stop-daemon --start --quiet --pidfile /tmp/xvfb_99.pid --make-pidfile --background --exec /usr/bin/Xvfb -- :99 -screen 0 1024x768x24 -ac +extension GLX +render -noreset

#             # Give xvfb time to start. 3 seconds is the default for all xvfb-run commands.
#             sleep 3
#       # Install (apt-get) packages
#       - install-packages:
#           packages: libqtwebkit-dev
#       # A step that executes `bundle install` command
#       - bundle-install

#       # A step that prepares the database.yml using the database in services
#       - rails-database-yml:
#           service: postgresql

#       - script:
#           name: setup database
#           code: bundle exec rake db:create db:migrate RAILS_ENV=test

#       - script:
#           name: rspec
#           code: bundle exec rspec

# deploy:
#   steps:
#     - heroku-deploy:
#         key-name: DEPLOYMENT_KEY
#         install-toolbelt: true
#         retry: true
#         run: rake db:migrate    


# Build definition
# See the Rails section on the wercker devcenter:
# http://devcenter.wercker.com/articles/languages/ruby/settingup-rails4.html
# You will want to define your database as follows:
# services:
#   - wercker/postgresql
# See more about services on our devcenter:
# http://devcenter.wercker.com/articles/services/
box: wercker/rvm
services:
  - postgres
build:
  steps:
    - script:
        name: Enable virtual display
        code: |-
          export DISPLAY=:99.0
          start-stop-daemon --start --quiet --pidfile /tmp/xvfb_99.pid --make-pidfile --background --exec /usr/bin/Xvfb -- :99 -screen 0 1024x768x24 -ac +extension GLX +render -noreset
          sleep 3
    - desmondmorris/selenium-install@0.0.2
    - rvm-use:
        version: 2.3.1
        
    - bundle-install
    - rails-database-yml

    - script:
        name: echo ruby information
        code: |
            echo "ruby version $(ruby --version) running"
            echo "from location $(which ruby)"
            echo -p "gem list: $(gem list)"

    - script:
        name: setup database
        code: bundle exec rake db:create db:migrate RAILS_ENV=test

    - script:
           name: rspec
           code: bundle exec rspec
deploy:
  steps:
    - heroku-deploy:
        key-name: DEPLOYMENT_KEY
        install-toolbelt: true
        retry: true
        run: rake db:migrate    
